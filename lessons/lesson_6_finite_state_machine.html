<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finite State Machines | The Robotics Institute</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #faf9f6;
            color: #292929;
            line-height: 1.6;
        }

        .nav-bar {
            padding: 1rem 2rem;
            background-color: #ffffff;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            box-sizing: border-box;
            border-bottom: 1px solid #e6e6e6;
        }

        .nav-bar a {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            color: #292929;
            text-decoration: none;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .article-container {
            max-width: 800px;
            margin: 80px auto 0;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .article-header {
            margin-bottom: 3rem;
        }

        .article-title {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            line-height: 1.3;
            color: #292929;
        }

        .article-meta {
            color: #757575;
            font-size: 0.9rem;
            margin-bottom: 2rem;
        }

        .article-content {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #292929;
        }

        .article-content p {
            margin-bottom: 1.5rem;
        }

        .media-container {
            margin-top: 2rem;
            text-align: center;
        }

        .media-container img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }

        .caption {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #757575;
        }

        .nav-button {
            position: absolute;
            top: 25%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }
        .nav-button:hover {
            background: rgba(255,255,255,1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .nav-button:active {
            transform: translateY(-50%) scale(0.95);
        }
        #prevBtn {
            left: 1rem;
        }
        #nextBtn {
            right: 1rem;
        }
        .fsm-container {
            position: relative;
            min-height: 300px;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            display: none;
            padding: 1rem;
            background: #fff3f3;
            border: 1px solid #ffcdd2;
            border-radius: 4px;
            color: #d32f2f;
            margin: 1rem 0;
        }
        .led.active {
            background: #ff6464;
            box-shadow: 0 0 30px #ff6464, 0 0 50px rgba(255, 100, 100, 0.5);
        }
        .drink-button.active {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }
        .dispenser.active {
            background: #ffd700 !important;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        .action-button:hover {
            opacity: 0.9;
        }
        .action-button:disabled {
            background: #444 !important;
            cursor: not-allowed;
        }
        .drink-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        #cokeCan, #pepsiCan {
            opacity: 0;
            transform: translateX(-50%) translateY(0);
        }
        #cokeCan.show, #pepsiCan.show {
            opacity: 1;
            transform: translateX(-50%) translateY(40px);
        }
        .gray-code {
            font-family: monospace;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .gray-code.changed {
            background-color: #ffd700;
            color: #000;
            font-weight: bold;
        }
    </style>
    <script>
        // Immediately check if JavaScript is enabled
        document.documentElement.classList.add('js-enabled');
        
        // Function to show error message
        function showError(message) {
            const errorDiv = document.getElementById('jsError');
            if (errorDiv) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = message;
            }
        }

        // Function to hide loading overlay
        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            
            // Hide loading overlay after a short delay to ensure everything is ready
            setTimeout(hideLoading, 500);
            
            const fsmImages = [
                '../imgs/fsm/fsm_1.jpg',
                '../imgs/fsm/fsm_2.jpg',
                '../imgs/fsm/fsm_3.jpg',
                '../imgs/fsm/fsm_4.jpg',
                '../imgs/fsm/fsm_5.jpg',
                '../imgs/fsm/fsm_6.jpg',
                '../imgs/fsm/fsm_7.jpg',
                '../imgs/fsm/fsm_8.jpg',
                '../imgs/fsm/fsm_9.jpg',
                '../imgs/fsm/fsm_10.jpg',
                '../imgs/fsm/fsm_11.jpg',
                '../imgs/fsm/fsm_12.jpg',
                '../imgs/fsm/fsm_13.jpg',
                '../imgs/fsm/fsm_14.jpg',
                '../imgs/fsm/fsm_15.jpg',
                '../imgs/fsm/fsm_16.jpg',
                '../imgs/fsm/fsm_17.jpg',
                '../imgs/fsm/fsm_18.jpg',
                '../imgs/fsm/fsm_19.jpg',
                '../imgs/fsm/fsm_20.jpg'
            ];

            const stepDescriptions = [
                'Let\'s begin by laying out all our states. Don\'t worry about the inputs and outputs for now; we\re just laying out our states in a diagram to give us space to add those in later.',
                'Here I added the output code for the inital state, S<sub>0</sub>. Since this state is waiting for the user to use the machine, all the outputs (the LEDs and dispensers) are off which is indicated by all 0s in Gray Code.',
                'Now I added the output code for S<sub>1</sub>, where the user has inserted money and is waiting for a selection. Thus, the two LEDSs are lit up, indicated by the two first bits of the Gray Code being 1.',
                'For S<sub>2</sub>, Coke has been selected, so the Coke LED remains on as a Coke can is being dispensed. So  corresponding Gray Code is 1010.',
                'Similarly to S<sub>2</sub>, S<sub>3</sub> is where Pepsi has been selected and is being dispensed. The Pepsi LED remains on as a Pepsi can is being dispensed, so the corresponding Gray Code is 1001.',
                'Now that we have Gray Code for all our states, we can start looking at triggers, or the transitions between states. I\'m first going to add a trigger between S<sub>0</sub> and itself (also called a "loop") to indicate that the machine is waiting for the user to use it.',
                'Each trigger has an input code, which is the Gray Code of the inputs that will cause the trigger to fire. In this case, we added an input code for that S<sub>0</sub> of is 0XXX, meaning that so long the first input is off (meaning that money has not been paid), the trigger will keep the FSM in S<sub>0</sub>. Since the other inputs dont\t matter so long as no money has been paid, the rest of them are X\'s.',
                'Now let\'s take a look at the trigger between S<sub>0</sub> and S<sub>1</sub>.',
                'To go from S<sub>0</sub> to S<sub>1</sub>, the machine needs to detect that money has been paid. So the input code is 1XXX, which means that so long as the first input is on (meaning that money has been paid), the trigger will fire and the machine will move to S<sub>1</sub>.',
                'Let\'s take a look at the loop for S<sub>1</sub>.',
                'The loop for S<sub>1</sub> indicates that the machine is waiting for a drink selection. As we\'re already in S<sub>1</sub> (meaning money has been paid), the first input must be 1. And since we\'re waiting for a selection, neither Coke nor Pepsi has been selected yet, so the second and third inputs must be 0 giving us a Gray Code of 100X.',
                'Now let\'s add the transition from S<sub>1</sub> to S<sub>2</sub> when Coke is selected.',
                'To go from S<sub>1</sub> to S<sub>2</sub>, we need money to be paid (1) and Coke to be selected (1). The input code is therefore 110X. Notice that the 0 for the Pepsi Selected input instead of an X - this is because we do actually care about the Pepsi selection, so we need to make sure it is 0.',
                'Similarly, let\'s add the triggers from S<sub>1</sub> to S<sub>3</sub> - money is paid (1) and Pepsi is selected which gives us 101X.',
                'Here we just added the loops for S<sub>2</sub> and S<sub>3</sub>.',
                'During these loops, the user is simply waiting for their selected drink to be dispensed. So as long as our 4th input, the dispenser sensor, reads 0 (or false), we are staying in those states.',
                'Now let\'s add the trigger from S<sub>2</sub> back to S<sub>0</sub>.',
                'If the Coke has been dispensed, our 4th input will read 1 which should reset the vending machine back to the inital waiting state, S<sub>0</sub>.',
                'We\'re about to do something very similar for S<sub>3</sub> back to S<sub>0</sub>.',
                'The same trigger input Gray Code of XXX1 will indicate that a Pepsi has been dispensed, so the machine resets us back to S<sub>0</sub>.'
                ];

            let currentStep = 0;
            const totalSteps = fsmImages.length;

            function updateFSM() {
                console.log('Updating FSM to step:', currentStep);
                const fsmImage = document.getElementById('fsmImage');
                const stepCounter = document.getElementById('stepCounter');
                const stepDescription = document.getElementById('stepDescription');
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');

                if (!fsmImage || !stepCounter || !stepDescription || !prevBtn || !nextBtn) {
                    showError('Could not initialize the interactive tool. Please refresh the page.');
                    return;
                }

                // Preload the next image
                const nextImage = new Image();
                nextImage.src = fsmImages[currentStep];
                nextImage.onload = function() {
                    fsmImage.src = fsmImages[currentStep];
                    stepCounter.textContent = `Step ${currentStep + 1} of ${totalSteps}`;
                    stepDescription.innerHTML = `<p style="margin: 0; color: #333;">${stepDescriptions[currentStep]}</p>`;
                    
                    prevBtn.style.opacity = currentStep === 0 ? '0.5' : '1';
                    nextBtn.style.opacity = currentStep === totalSteps - 1 ? '0.5' : '1';
                };
                nextImage.onerror = function() {
                    showError('Could not load the image. Please check your internet connection and refresh the page.');
                };
            }

            function prevStep() {
                console.log('Previous button clicked');
                if (currentStep > 0) {
                    currentStep--;
                    updateFSM();
                }
            }

            function nextStep() {
                console.log('Next button clicked');
                if (currentStep < totalSteps - 1) {
                    currentStep++;
                    updateFSM();
                }
            }

            // Add event listeners
            document.getElementById('prevBtn').addEventListener('click', prevStep);
            document.getElementById('nextBtn').addEventListener('click', nextStep);

            // Initialize
            updateFSM();
        });
    </script>
</head>
<body>
    <nav class="nav-bar">
        <a href="../index.html">← Back to Home</a>
    </nav>

    <article class="article-container">
        <header class="article-header">
            <h1 class="article-title">Finite State Machines</h1>
            <div class="article-meta">
                Written by Nathan Daniel • Last updated Jan 2025
            </div>
        </header>

        <div class="article-content">
            <p>
                AI seems to be everywhere right now: driving cars, generating images, counting the number of r's in the word "strawberries". It can be great for finding patterns in large datasets, but in robotics we're usually reading a bunch of sensor readings and waiting for different thresholds to be met. That's where <b>Finite State MachineS (FSM's)</b> come in.
            </p>

            <div class="media-container">
                <img src="../imgs/lesson_6_meme.png" alt="AI Meme" style="max-width: 60%; border-radius: 4px;">
                <p class="caption">Don't worry, we'll get to AI in a few lessons. That B2B SaaS idea can wait.</p>
            </div>

            <p>
                A lot of the "thinking" robots need to complete tasks doesn't require machine learning or neural networks. Like most things in your life, it just needs ✨<b>structure</b>✨.

            </p>
            <div class="media-container">
                <img src="../imgs/lesson_2_sense_think_act_loop.png" alt="Think Sense Act Loop" style="max-width: 60%; border-radius: 4px;">
                <p class="caption">Recall the Think-Sense-Act loop from Lesson 2.</p>
            </div>

            <p>
                An FSM doesn't learn or adapt; it just follows a set of clear rules. You break a robot's behavior into <b>states</b> (like "moving forward," "turning," or "charging") and then define <b>inputs</b> that trigger  switches between them. And depending on the state, there may be one or two <b>outputs</b> occurring before moving around to more states. FSMs don't make the robot "smart," but they <b>give structure to its decisions</b>, and that's often exactly what you need to build reliable, predictable behavior.

            </p>

            <p>
                FSM's can be used for things other than robots too - let's use an example of how life used to be like for a software engineer before COVID.
            </p>
            <div class="media-container">
                <img src="../imgs/lesson_6_fsm_simple.png" alt="simple fsm" style="max-width: 60%; border-radius: 4px;">
            </div>

            <p>
                This example is pretty self explanatory - the states are WORK, HOME, and BED, and the triggers are the arrows in between the states. However this example is missing inputs and outputs.
            </p>

            <p>
                Now let's do a slightly more complex FSM with something I'm calling the <i>"Illusion of Free Will Vending Machine"</i>. The IoFWVM is a basic vending machine with two options: Coke or Pepsi. When it's waiting for the user to make their choice, both the Coke and Pepsi buttons are lit up, signaling that it's ready. The moment you press one - say, Coke - the machine will only have the Coke button lit up as it dispenses the beverage. The same would work in reverse if you selected Pepsi. After the drink has been dispensed, the vending machine resets itself. It also doesn't accept cash; it'll only accept a card so that there isn't any need to return change to the user.

            </p>

            <p>
                Let's define the initial states before handling inputs and outputs.
            </p>

            <div style="margin: 2rem 0; overflow-x: auto;">
                <h3 style="color: #5E35B1;">States of the IoFW Vending Machine</h3>
                <table style="width: 100%; border-collapse: separate; border-spacing: 0; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <thead>
                        <tr>
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #e6e6e6; color: #5E35B1;">State</th>
                            <th style="padding: 1rem; text-align: center; border-bottom: 2px solid #e6e6e6; color: #5E35B1;">Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6;"><b>S<sub>0</sub> - Idle</b></td>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6;">The IoFW vending machine is patiently awaiting someone to use it. We'd call this state S<sub>0</sub>, the initial or default state.</td>
                        </tr>
                        <tr>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6;"><b>S<sub>1</sub> - Money Inserted + Waiting for Selection</b></td>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6;">Someone has inserted money into the vending machine, and it's now awaiting the choice of Pepsi or Coke with both buttons lit up.</td>
                        </tr>
                        <tr>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6;"><b>S<sub>2</sub> - Dispensing Coke</b></td>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6;">Coke was chosen, so it is in the process of dispensing a can of Coke as the Coke button stays lit.</td>
                        </tr>
                        <tr>
                            <td style="padding: 1rem;"><b>S<sub>3</sub> - Dispensing Pepsi</b></td>
                            <td style="padding: 1rem;">Pepsi was chosen, so it is in the process of dispensing a can of Pepsi as the Pepsi button stays lit.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <p>
                Now let's define our inputs. I'm gonna use something called Gray Code, which is a technique of representing a value with a series of bits. Every input is given a bit which can have 1 of 3 values: 0, which means it's off, 1, which means it's on, and X which means it doesn't matter whether it's on or off in the current situation. So if I have 5 inputs and want to say that input #1 is on, input #5 is off, and the rest don't matter, the corresponding Gray Code would be: 1XXX0.
            </p>

            <p>
                The vending machine has 4 inputs:
            </p>

            <div style="margin: 2rem 0; overflow-x: auto;">
                <h3 style="color: #2E7D32;">Inputs of the IoFW Vending Machine</h3>
                <table style="width: 100%; border-collapse: separate; border-spacing: 0; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <thead>
                        <tr>
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #e6e6e6; color: #2E7D32;">Input</th>
                            <th style="padding: 1rem; text-align: center; border-bottom: 2px solid #e6e6e6; color: #2E7D32;">Description</th>
                            <th style="padding: 1rem; text-align: center; border-bottom: 2px solid #e6e6e6; color: #2E7D32;">Gray Code</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6;"><b>Money Paid</b></td>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6;">When this is on, it means that the user has paid for a drink. When off, it means it has not been paid.</td>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6; text-align: center;"><code>1XXX</code></td>
                        </tr>
                        <tr>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6;"><b>Coke Selected</b></td>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6;">When this is on, it means the user has selected Coke.</td>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6; text-align: center;"><code>X1XX</code></td>
                        </tr>
                        <tr>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6;"><b>Pepsi Selected</b></td>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6;">When this is on, it means the user has selected Pepsi.</td>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6; text-align: center;"><code>XX1X</code></td>
                        </tr>
                        <tr>
                            <td style="padding: 1rem;"><b>Dispenser Sensor</b></td>
                            <td style="padding: 1rem;">Let's pretend we have a simple IR sensor at the bottom of the machine checking to see when a snack has dropped. When it's on, it means it's detected a snack that's fallen, and when it's off it means that no snack has fallen and isn't detected.</td>
                            <td style="padding: 1rem; text-align: center;"><code>XXX1</code></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <p>
                Now that we have our states and inputs, we can define the outputs. Outputs are the actions that the vending machine will take when it's in a certain state.
            </p>

            <div style="margin: 2rem 0; overflow-x: auto;">
                <h3 style="color: #FF6464;">Outputs of the IoFW Vending Machine</h3>
                <table style="width: 100%; border-collapse: separate; border-spacing: 0; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <thead>
                        <tr>
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #e6e6e6; color: #FF6464;">Output</th>
                            <th style="padding: 1rem; text-align: center; border-bottom: 2px solid #e6e6e6; color: #FF6464;">Description</th>
                            <th style="padding: 1rem; text-align: center; border-bottom: 2px solid #e6e6e6; color: #FF6464;">Gray Code</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6;"><b>Coke LED</b></td>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6;">When on, the LED for the Coke button is on.</td>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6; text-align: center;"><code>1XXX</code></td>
                        </tr>
                        <tr>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6;"><b>Pepsi LED</b></td>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6;">When on, the LED for the Pepsi button is on.</td>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6; text-align: center;"><code>X1XX</code></td>
                        </tr>
                        <tr>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6;"><b>Coke Dispenser</b></td>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6;">When this is on, a can of coke is being dispensed.</td>
                            <td style="padding: 1rem; border-bottom: 1px solid #e6e6e6; text-align: center;"><code>XX1X</code></td>
                        </tr>
                        <tr>
                            <td style="padding: 1rem;"><b>Pepsi Dispenser</b></td>
                            <td style="padding: 1rem;">When this is on, a can of pepsi is being dispensed.</td>
                            <td style="padding: 1rem; text-align: center;"><code>XXX1</code></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p style="margin: 4rem 0;">
                Alright, that was a lot of information about a hypothetical vending machine in a short amount of time. Try out this interactive tool below to see how the vending machine works and how the state, inputs, and outputs work together as you get a drink (also there's a reset button in case my JavaScript skills break your webpage, but it's not actually real in the example).
            </p>

            <div style="margin: 6rem 0; background: #f8f9fa; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 2rem;">
                <h2 style="color: #333; margin-bottom: 2rem;">Interactive Vending Machine</h2>
                
                <div style="display: flex; gap: 2rem; align-items: start;">
                    <!-- Vending Machine Interface -->
                    <div style="flex: 1; background: #1a1a1a; border-radius: 8px; padding: 2rem; text-align: center;">
                        <div style="margin-bottom: 2rem;">
                            <h3 style="color: #fff; margin-bottom: 1rem;">Current State: <span id="currentState">S<sub>0</sub> - Idle</span></h3>
                            <div style="display: flex; gap: 1rem; justify-content: center;">
                                <button id="resetButton" class="action-button" style="background: #666; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; cursor: pointer; font-size: 1.1rem;">Reset</button>
                                <button id="insertMoney" class="action-button" style="background: #4CAF50; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; cursor: pointer; font-size: 1.1rem;">Insert Money</button>
                            </div>
                        </div>

                        <div style="display: flex; gap: 2rem; justify-content: center; margin-bottom: 2rem;">
                            <div class="button-container">
                                <button id="cokeButton" class="drink-button" disabled style="background: #e0e0e0; border: none; padding: 1.5rem; border-radius: 50%; width: 100px; height: 100px; cursor: pointer; transition: all 0.3s ease; background-image: url('../imgs/cocacola.webp'); background-size: cover; background-position: center; filter: brightness(0.7); opacity: 0.7;"></button>
                                <div class="led" id="cokeLed" style="width: 20px; height: 20px; background: #ccc; border-radius: 50%; margin: 1rem auto;"></div>
                            </div>
                            <div class="button-container">
                                <button id="pepsiButton" class="drink-button" disabled style="background: #e0e0e0; border: none; padding: 1.5rem; border-radius: 50%; width: 100px; height: 100px; cursor: pointer; transition: all 0.3s ease; background-image: url('../imgs/pepsi.jpg'); background-size: cover; background-position: center; filter: brightness(0.7); opacity: 0.7;"></button>
                                <div class="led" id="pepsiLed" style="width: 20px; height: 20px; background: #ccc; border-radius: 50%; margin: 1rem auto;"></div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 2rem; justify-content: center; margin-bottom: 2rem;">
                            <div class="dispenser" style="text-align: center;">
                                <div style="font-size: 1.2rem; margin-bottom: 0.5rem; color: #fff;">Coke Dispenser</div>
                                <div id="cokeDispenser" style="width: 60px; height: 60px; background: #333; border-radius: 8px; margin: 0 auto; position: relative;">
                                    <div id="cokeLoading" class="loading-spinner" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
                                </div>
                            </div>
                            <div class="dispenser" style="text-align: center;">
                                <div style="font-size: 1.2rem; margin-bottom: 0.5rem; color: #fff;">Pepsi Dispenser</div>
                                <div id="pepsiDispenser" style="width: 60px; height: 60px; background: #333; border-radius: 8px; margin: 0 auto; position: relative;">
                                    <div id="pepsiLoading" class="loading-spinner" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Drink Output Area -->
                        <div id="drinkOutput" style="height: 100px; margin-top: 2rem; position: relative;">
                            <div id="cokeCan" style="display: none; width: 40px; height: 60px; background: #ff0000; border-radius: 4px; position: absolute; left: 50%; transform: translateX(-50%); transition: all 0.5s ease;"></div>
                            <div id="pepsiCan" style="display: none; width: 40px; height: 60px; background: #0047AB; border-radius: 4px; position: absolute; left: 50%; transform: translateX(-50%); transition: all 0.5s ease;"></div>
                        </div>
                    </div>

                    <!-- State Information -->
                    <div style="flex: 1; background: #fff; border-radius: 8px; padding: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <h3 style="color: #333; margin-bottom: 1rem;">Current Inputs</h3>
                        <div id="currentInputs" style="margin-bottom: 2rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; margin-bottom: 0.5rem;">
                                <span>Money Paid:</span>
                                <span id="moneyPaid" class="gray-code">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; margin-bottom: 0.5rem;">
                                <span>Coke Selected:</span>
                                <span id="cokeSelected" class="gray-code">X</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; margin-bottom: 0.5rem;">
                                <span>Pepsi Selected:</span>
                                <span id="pepsiSelected" class="gray-code">X</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                                <span>Dispenser Sensor:</span>
                                <span id="dispenserSensor" class="gray-code">X</span>
                            </div>
                        </div>

                        <h3 style="color: #333; margin-bottom: 1rem;">Current Outputs</h3>
                        <div id="currentOutputs">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; margin-bottom: 0.5rem;">
                                <span>Coke LED:</span>
                                <span id="cokeLedStatus" class="gray-code">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; margin-bottom: 0.5rem;">
                                <span>Pepsi LED:</span>
                                <span id="pepsiLedStatus" class="gray-code">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; margin-bottom: 0.5rem;">
                                <span>Coke Dispenser:</span>
                                <span id="cokeDispenserStatus" class="gray-code">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                                <span>Pepsi Dispenser:</span>
                                <span id="pepsiDispenserStatus" class="gray-code">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <p>
                Now that you've played around with the IoFWVM, I'm gonna build it out step by step in the diagram below.
            </p>

            <div style="margin: 4rem -2rem; width: 100vw; position: relative; left: 50%; right: 50%; margin-left: -50vw; margin-right: -50vw; background: #f8f9fa; padding: 3rem 0;">
                <h2 style="color: #333; margin-bottom: 2rem; padding: 0 2rem; max-width: 1400px; margin-left: auto; margin-right: auto;">Building the Finite State Machine</h2>
                
                <div style="background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 3rem; margin-bottom: 2rem; max-width: 1400px; margin-left: auto; margin-right: auto;">
                    <!-- Error Message -->
                    <div id="jsError" class="error-message"></div>
                    
                    <!-- Step Counter -->
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <span id="stepCounter" style="background: #f0f0f0; padding: 1rem 2rem; border-radius: 20px; font-size: 1.3rem;">Step 1 of 10</span>
                    </div>
                    
                    <!-- FSM Image Container -->
                    <div class="fsm-container" style="min-height: 700px; display: flex; align-items: center; justify-content: center;">
                        <!-- Loading Overlay -->
                        <div id="loadingOverlay" class="loading-overlay">
                            <div class="loading-spinner"></div>
                        </div>
                        
                        <img id="fsmImage" src="../imgs/fsm/fsm_1.jpg" alt="FSM Step 1" style="width: 100%; height: auto; border-radius: 8px; max-height: 800px; object-fit: contain;">
                        
                        <!-- Navigation Buttons -->
                        <button id="prevBtn" class="nav-button" style="width: 60px; height: 60px; font-size: 2rem;">←</button>
                        <button id="nextBtn" class="nav-button" style="width: 60px; height: 60px; font-size: 2rem;">→</button>
                    </div>

                    <!-- Description -->
                    <div id="stepDescription" style="background: #f8f9fa; padding: 2.5rem; border-radius: 8px; margin-top: 2rem; font-size: 1.3rem; line-height: 1.6; max-width: 1000px; margin-left: auto; margin-right: auto;">
                        <p style="margin: 0; color: #333;">
                            Step 1: Let's begin by laying out all our states. Don't worry about the inputs and outputs for now.
                        </p>
                    </div>

                    <!-- Reference Table -->
                    <div style="display: flex; gap: 2rem; margin-top: 2rem; max-width: 1000px; margin-left: auto; margin-right: auto;">
                        <!-- Inputs Table -->
                        <div style="flex: 1; background: #f8f9fa; border-radius: 8px; padding: 1.5rem;">
                            <h3 style="color: #2E7D32; margin-top: 0; margin-bottom: 1rem;">Inputs Reference</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr>
                                    <th style="text-align: left; padding: 0.5rem; border-bottom: 2px solid #e6e6e6;">Input</th>
                                    <th style="text-align: center; padding: 0.5rem; border-bottom: 2px solid #e6e6e6;">Gray Code</th>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e6e6e6;">Money Paid</td>
                                    <td style="text-align: center; padding: 0.5rem; border-bottom: 1px solid #e6e6e6;"><code>1XXX</code></td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e6e6e6;">Coke Selected</td>
                                    <td style="text-align: center; padding: 0.5rem; border-bottom: 1px solid #e6e6e6;"><code>X1XX</code></td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e6e6e6;">Pepsi Selected</td>
                                    <td style="text-align: center; padding: 0.5rem; border-bottom: 1px solid #e6e6e6;"><code>XX1X</code></td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem;">Dispenser Sensor</td>
                                    <td style="text-align: center; padding: 0.5rem;"><code>XXX1</code></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Outputs Table -->
                        <div style="flex: 1; background: #f8f9fa; border-radius: 8px; padding: 1.5rem;">
                            <h3 style="color: #FF6464; margin-top: 0; margin-bottom: 1rem;">Outputs Reference</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr>
                                    <th style="text-align: left; padding: 0.5rem; border-bottom: 2px solid #e6e6e6;">Output</th>
                                    <th style="text-align: center; padding: 0.5rem; border-bottom: 2px solid #e6e6e6;">Gray Code</th>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e6e6e6;">Coke LED</td>
                                    <td style="text-align: center; padding: 0.5rem; border-bottom: 1px solid #e6e6e6;"><code>1XXX</code></td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e6e6e6;">Pepsi LED</td>
                                    <td style="text-align: center; padding: 0.5rem; border-bottom: 1px solid #e6e6e6;"><code>X1XX</code></td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #e6e6e6;">Coke Dispenser</td>
                                    <td style="text-align: center; padding: 0.5rem; border-bottom: 1px solid #e6e6e6;"><code>XX1X</code></td>
                                </tr>
                                <tr>z
                                    <td style="padding: 0.5rem;">Pepsi Dispenser</td>
                                    <td style="text-align: center; padding: 0.5rem;"><code>XXX1</code></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <p style="margin-top: 4rem;">
                        Alright, so hopefully you now have some idea of how FSM's work. This article might be a bit contrived but I'm hoping that it's a good introduction to the concept with an interesting example. FSM's are a great way to structure a robot's behavior and to track what all your actuators and sensors are doing in any given moment.
                    </p>
                </div>
            </div>

            <script>
                let currentState = 0;
                let dispensingTimeout = null;
                let previousInputs = '0XXX';
                let previousOutputs = '0000';
                const states = [
                    { name: 'S<sub>0</sub> - Idle', inputs: '0XXX', outputs: '0000' },
                    { name: 'S<sub>1</sub> - Money Inserted', inputs: '1XXX', outputs: '1100' },
                    { name: 'S<sub>2</sub> - Dispensing Coke', inputs: 'X1XX', outputs: '1010' },
                    { name: 'S<sub>3</sub> - Dispensing Pepsi', inputs: 'XX1X', outputs: '0101' }
                ];

                function resetMachine() {
                    // Clear any existing timeouts
                    if (dispensingTimeout) {
                        clearTimeout(dispensingTimeout);
                        dispensingTimeout = null;
                    }
                    
                    // Hide drinks
                    document.getElementById('cokeCan').style.display = 'none';
                    document.getElementById('pepsiCan').style.display = 'none';
                    document.getElementById('cokeCan').classList.remove('show');
                    document.getElementById('pepsiCan').classList.remove('show');
                    
                    // Hide loading spinners
                    document.getElementById('cokeLoading').style.display = 'none';
                    document.getElementById('pepsiLoading').style.display = 'none';
                    
                    // Reset to initial state
                    updateState(0);
                }

                function showDrink(type) {
                    const can = document.getElementById(type + 'Can');
                    const loading = document.getElementById(type + 'Loading');
                    
                    // Show loading spinner
                    loading.style.display = 'block';
                    
                    // After 4 seconds, show the drink
                    dispensingTimeout = setTimeout(() => {
                        loading.style.display = 'none';
                        can.style.display = 'block';
                        // Trigger reflow
                        can.offsetHeight;
                        can.classList.add('show');
                        
                        // Update dispenser sensor to 1
                        document.getElementById('dispenserSensor').textContent = '1';
                        document.getElementById('dispenserSensor').classList.add('changed');
                        
                        // After drink is shown, reset to initial state
                        setTimeout(() => {
                            resetMachine();
                        }, 2000);
                    }, 4000);
                }

                function highlightChanges(newValue, oldValue, elements) {
                    for (let i = 0; i < newValue.length; i++) {
                        if (newValue[i] === '1') {
                            elements[i].classList.add('changed');
                        } else {
                            elements[i].classList.remove('changed');
                        }
                    }
                }

                function updateState(newState) {
                    currentState = newState;
                    const state = states[currentState];
                    
                    // Update state display
                    document.getElementById('currentState').innerHTML = state.name;
                    
                    // Update inputs
                    const inputs = state.inputs.split('');
                    const inputElements = [
                        document.getElementById('moneyPaid'),
                        document.getElementById('cokeSelected'),
                        document.getElementById('pepsiSelected'),
                        document.getElementById('dispenserSensor')
                    ];
                    
                    // Update outputs
                    const outputs = state.outputs.split('');
                    const outputElements = [
                        document.getElementById('cokeLedStatus'),
                        document.getElementById('pepsiLedStatus'),
                        document.getElementById('cokeDispenserStatus'),
                        document.getElementById('pepsiDispenserStatus')
                    ];
                    
                    // Highlight changes
                    highlightChanges(state.inputs, previousInputs, inputElements);
                    highlightChanges(state.outputs, previousOutputs, outputElements);
                    
                    // Update values
                    inputElements.forEach((el, i) => el.textContent = inputs[i]);
                    outputElements.forEach((el, i) => el.textContent = outputs[i]);
                    
                    // Store current values for next comparison
                    previousInputs = state.inputs;
                    previousOutputs = state.outputs;
                    
                    // Update visual elements
                    document.getElementById('cokeLed').classList.toggle('active', outputs[0] === '1');
                    document.getElementById('pepsiLed').classList.toggle('active', outputs[1] === '1');
                    document.getElementById('cokeDispenser').classList.toggle('active', outputs[2] === '1');
                    document.getElementById('pepsiDispenser').classList.toggle('active', outputs[3] === '1');
                    
                    // Update button states
                    document.getElementById('insertMoney').disabled = currentState !== 0;
                    document.getElementById('cokeButton').disabled = currentState !== 1;
                    document.getElementById('pepsiButton').disabled = currentState !== 1;
                    
                    // Update button brightness based on state
                    if (currentState === 1) {
                        // Both buttons bright in money inserted state
                        document.getElementById('cokeButton').style.filter = 'brightness(1)';
                        document.getElementById('cokeButton').style.opacity = '1';
                        document.getElementById('pepsiButton').style.filter = 'brightness(1)';
                        document.getElementById('pepsiButton').style.opacity = '1';
                    } else if (currentState === 2) {
                        // Only Coke bright in dispensing Coke state
                        document.getElementById('cokeButton').style.filter = 'brightness(1)';
                        document.getElementById('cokeButton').style.opacity = '1';
                        document.getElementById('pepsiButton').style.filter = 'brightness(0.7)';
                        document.getElementById('pepsiButton').style.opacity = '0.7';
                    } else if (currentState === 3) {
                        // Only Pepsi bright in dispensing Pepsi state
                        document.getElementById('cokeButton').style.filter = 'brightness(0.7)';
                        document.getElementById('cokeButton').style.opacity = '0.7';
                        document.getElementById('pepsiButton').style.filter = 'brightness(1)';
                        document.getElementById('pepsiButton').style.opacity = '1';
                    } else {
                        // Both dim in idle state
                        document.getElementById('cokeButton').style.filter = 'brightness(0.7)';
                        document.getElementById('cokeButton').style.opacity = '0.7';
                        document.getElementById('pepsiButton').style.filter = 'brightness(0.7)';
                        document.getElementById('pepsiButton').style.opacity = '0.7';
                    }

                    // Handle dispensing states
                    if (currentState === 2) {
                        showDrink('coke');
                    } else if (currentState === 3) {
                        showDrink('pepsi');
                    }
                }

                // Event listeners
                document.getElementById('resetButton').addEventListener('click', resetMachine);
                document.getElementById('insertMoney').addEventListener('click', () => updateState(1));
                document.getElementById('cokeButton').addEventListener('click', () => updateState(2));
                document.getElementById('pepsiButton').addEventListener('click', () => updateState(3));

                // Initialize
                updateState(0);
            </script>

        </div>
    </article>
</body>
</html> 